<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡æ°´å°å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
        }
        .container {
            margin-top: 20px;
        }
        #imagePreview {
            max-width: 100%;
            margin: 20px 0;
            display: none;
        }
        .controls {
            margin: 20px 0;
        }
        input, button {
            margin: 10px;
            padding: 8px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        #clearBtn {
            background-color: #f44336;
        }
        #clearBtn:hover {
            background-color: #da190b;
        }
        #watermarkText {
            width: 80%;
            max-width: 300px;
        }
        .options {
            margin: 20px 0;
        }
        .options label {
            margin: 0 10px;
        }
        .privacy-notice {
            margin: 20px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            font-size: 0.9em;
            color: #666;
        }
    </style>
</head>
<body>
    <h1>å›¾ç‰‡æ°´å°å·¥å…·</h1>
    <div class="privacy-notice">
        ğŸ”’ éšç§æç¤ºï¼šæ‰€æœ‰å›¾ç‰‡å¤„ç†éƒ½åœ¨æ‚¨çš„æµè§ˆå™¨ä¸­å®Œæˆï¼Œæˆ‘ä»¬ä¸ä¼šä¿å­˜æˆ–ä¸Šä¼ æ‚¨çš„å›¾ç‰‡
    </div>
    <div class="container">
        <input type="file" id="imageInput" accept="image/*">
        <img id="imagePreview">
        <div class="controls">
            <input type="text" id="watermarkText" placeholder="è¾“å…¥æ°´å°æ–‡å­—">
            <div class="options">
                <label>
                    å­—ä½“å¤§å°:
                    <input type="number" id="fontSize" value="48" min="8" max="200">
                </label>
                <label>
                    é€æ˜åº¦:
                    <input type="range" id="opacity" min="0" max="100" value="30">
                </label>
                <label>
                    é¢œè‰²:
                    <select id="watermarkColor">
                        <option value="white">ç™½è‰²</option>
                        <option value="black">é»‘è‰²</option>
                        <option value="red">çº¢è‰²</option>
                        <option value="blue">è“è‰²</option>
                    </select>
                </label>
            </div>
            <button onclick="addWatermark()">æ·»åŠ æ°´å°</button>
            <button onclick="downloadImage()" id="downloadBtn" style="display: none;">ä¸‹è½½å›¾ç‰‡</button>
            <button onclick="clearAll()" id="clearBtn">æ¸…é™¤é‡ç½®</button>
        </div>
    </div>

    <script>
        let originalImage = null;
        let watermarkedImage = null;

        document.getElementById('imageInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = document.getElementById('imagePreview');
                    img.src = event.target.result;
                    img.style.display = 'block';
                    originalImage = event.target.result;
                    document.getElementById('downloadBtn').style.display = 'none';
                }
                reader.readAsDataURL(file);
            }
        });

        function clearAll() {
            // æ¸…é™¤å›¾ç‰‡é¢„è§ˆ
            const imagePreview = document.getElementById('imagePreview');
            imagePreview.src = '';
            imagePreview.style.display = 'none';
            
            // æ¸…é™¤æ–‡ä»¶è¾“å…¥
            document.getElementById('imageInput').value = '';
            
            // æ¸…é™¤æ°´å°æ–‡æœ¬
            document.getElementById('watermarkText').value = '';
            
            // é‡ç½®æ‰€æœ‰é€‰é¡¹åˆ°é»˜è®¤å€¼
            document.getElementById('fontSize').value = '48';
            document.getElementById('opacity').value = '30';
            document.getElementById('watermarkColor').value = 'white';
            
            // éšè—ä¸‹è½½æŒ‰é’®
            document.getElementById('downloadBtn').style.display = 'none';
            
            // æ¸…é™¤å­˜å‚¨çš„å›¾ç‰‡æ•°æ®
            originalImage = null;
            watermarkedImage = null;
        }

        function addWatermark() {
            if (!originalImage) {
                alert('è¯·å…ˆä¸Šä¼ å›¾ç‰‡');
                return;
            }

            const text = document.getElementById('watermarkText').value;
            if (!text) {
                alert('è¯·è¾“å…¥æ°´å°æ–‡å­—');
                return;
            }

            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();

            img.onload = function() {
                // è®¾ç½®canvaså°ºå¯¸ä¸ºå›¾ç‰‡å®é™…å°ºå¯¸
                canvas.width = img.width;
                canvas.height = img.height;

                // ç»˜åˆ¶åŸå§‹å›¾ç‰‡
                ctx.drawImage(img, 0, 0);

                // è·å–æ°´å°è®¾ç½®
                const fontSize = document.getElementById('fontSize').value;
                const opacity = document.getElementById('opacity').value / 100;
                const color = document.getElementById('watermarkColor').value;

                // è®¾ç½®æ°´å°æ ·å¼
                ctx.font = `${fontSize}px Arial`;
                ctx.fillStyle = color;
                ctx.globalAlpha = opacity;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';

                // è®¡ç®—æ–‡å­—å®½åº¦
                const textWidth = ctx.measureText(text).width;

                // åœ¨æ•´ä¸ªå›¾ç‰‡ä¸Šé‡å¤æ·»åŠ æ°´å°
                const spacing = textWidth * 1.5; // æ°´å°ä¹‹é—´çš„é—´è·
                const angleInRadians = -Math.PI / 6; // -30åº¦è§’

                ctx.save(); // ä¿å­˜å½“å‰çŠ¶æ€
                ctx.rotate(angleInRadians);

                // è®¡ç®—æ—‹è½¬åéœ€è¦è¦†ç›–çš„èŒƒå›´
                const diagonal = Math.sqrt(canvas.width * canvas.width + canvas.height * canvas.height);
                const xStart = -diagonal;
                const xEnd = diagonal;
                const yStart = -diagonal;
                const yEnd = diagonal;

                // é‡å¤ç»˜åˆ¶æ°´å°
                for (let y = yStart; y < yEnd; y += spacing) {
                    for (let x = xStart; x < xEnd; x += spacing) {
                        ctx.fillText(text, x, y);
                    }
                }

                ctx.restore(); // æ¢å¤åˆ°ä¹‹å‰çš„çŠ¶æ€

                // æ˜¾ç¤ºå¤„ç†åçš„å›¾ç‰‡
                const previewImg = document.getElementById('imagePreview');
                watermarkedImage = canvas.toDataURL('image/jpeg', 1.0);
                previewImg.src = watermarkedImage;
                document.getElementById('downloadBtn').style.display = 'inline-block';
            };

            img.src = originalImage;
        }

        function downloadImage() {
            if (!watermarkedImage) {
                alert('è¯·å…ˆæ·»åŠ æ°´å°');
                return;
            }

            const link = document.createElement('a');
            link.download = 'watermarked-image.jpg';
            link.href = watermarkedImage;
            link.click();
        }
    </script>
</body>
</html>